# multi-container.yaml
# Pod demonstrating multi-container patterns:
#   - Init container: writes an HTML config file
#   - Main container: nginx serves the generated content
#   - Sidecar container: tails the nginx access logs
---
apiVersion: v1
kind: Pod
metadata:
  name: multi-container
  namespace: lab-apps
  labels:
    app: multi-container
    environment: lab
  annotations:
    description: "Demonstrates init, main, and sidecar container patterns"
spec:
  initContainers:
    - name: init-config
      image: busybox:1.36
      command: ["/bin/sh", "-c"]
      args:
        - |
          cat <<'EOF' > /usr/share/nginx/html/index.html
          <!DOCTYPE html>
          <html>
          <head><title>Multi-Container Pod</title></head>
          <body>
            <h1>AKS Landing Zone Lab</h1>
            <p>This page was generated by the init container.</p>
            <p>Hostname: $(hostname)</p>
            <p>Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)</p>
          </body>
          </html>
          EOF
      volumeMounts:
        - name: html-volume
          mountPath: /usr/share/nginx/html
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 128Mi
  containers:
    - name: nginx
      image: nginx:alpine
      ports:
        - containerPort: 80
      volumeMounts:
        - name: html-volume
          mountPath: /usr/share/nginx/html
        - name: log-volume
          mountPath: /var/log/nginx
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi
      livenessProbe:
        httpGet:
          path: /
          port: 80
        initialDelaySeconds: 5
        periodSeconds: 10
    - name: log-tailer
      image: busybox:1.36
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "Waiting for nginx log file...";
          while [ ! -f /var/log/nginx/access.log ]; do sleep 1; done;
          echo "Tailing nginx access log...";
          tail -f /var/log/nginx/access.log
      volumeMounts:
        - name: log-volume
          mountPath: /var/log/nginx
          readOnly: true
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 128Mi
  volumes:
    - name: html-volume
      emptyDir: {}
    - name: log-volume
      emptyDir: {}
