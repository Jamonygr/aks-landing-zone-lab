# db-seed-job.yaml
# Kubernetes Job to initialize SQL schema and seed sample data.
# Run once after database creation: kubectl apply -f k8s/apps/db-seed-job.yaml
---
apiVersion: batch/v1
kind: Job
metadata:
  name: db-seed
  namespace: lab-apps
  labels:
    app: db-seed
    environment: lab
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: db-seed
        environment: lab
        azure.workload.identity/use: "true"
    spec:
      serviceAccountName: learning-hub-sa
      restartPolicy: Never
      containers:
        - name: db-seed
          image: mcr.microsoft.com/mssql-tools18:latest
          command: ["/bin/bash", "-c"]
          args:
            - |
              echo "=== AKS Learning Hub - Database Seed ==="
              echo "Waiting for SQL Server to be ready..."
              sleep 10

              SQLCMD="/opt/mssql-tools18/bin/sqlcmd"
              if [ ! -x "$SQLCMD" ]; then
                SQLCMD="/opt/mssql-tools/bin/sqlcmd"
              fi
              if [ ! -x "$SQLCMD" ]; then
                echo "ERROR: sqlcmd not found in container image"
                exit 1
              fi

              SERVER="$SQL_SERVER_FQDN"
              DB="$SQL_DATABASE_NAME"
              USER="$SQL_ADMIN_USER"
              PASS=""

              # Parse User ID and Password from ADO.NET connection string secret.
              if [ -n "$SQL_CONNECTION_STRING" ]; then
                USER_FROM_CONN=$(echo "$SQL_CONNECTION_STRING" | awk -F';' 'BEGIN{IGNORECASE=1} {for(i=1;i<=NF;i++){if($i ~ /^User ID=/){sub(/^User ID=/,"",$i); print $i; exit}}}')
                PASS_FROM_CONN=$(echo "$SQL_CONNECTION_STRING" | awk -F';' 'BEGIN{IGNORECASE=1} {for(i=1;i<=NF;i++){if($i ~ /^Password=/){sub(/^Password=/,"",$i); print $i; exit}}}')

                if [ -n "$USER_FROM_CONN" ]; then
                  USER="$USER_FROM_CONN"
                fi
                PASS="$PASS_FROM_CONN"
              fi

              if [ -z "$PASS" ]; then
                echo "ERROR: Could not extract SQL password from SQL_CONNECTION_STRING"
                exit 1
              fi

              echo "Creating tables..."
              $SQLCMD -S "$SERVER" -d "$DB" -U "$USER" -P "$PASS" -Q "
              IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'posts')
              CREATE TABLE posts (
                id INT IDENTITY(1,1) PRIMARY KEY,
                title NVARCHAR(200) NOT NULL,
                slug NVARCHAR(200) NOT NULL UNIQUE,
                content NVARCHAR(MAX) NOT NULL,
                category NVARCHAR(50) NOT NULL,
                created_at DATETIME2 DEFAULT GETUTCDATE()
              );

              IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'exercises')
              CREATE TABLE exercises (
                id INT IDENTITY(1,1) PRIMARY KEY,
                title NVARCHAR(200) NOT NULL,
                description NVARCHAR(500) NOT NULL,
                difficulty NVARCHAR(20) NOT NULL,
                completed BIT DEFAULT 0
              );

              IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'projects')
              CREATE TABLE projects (
                id INT IDENTITY(1,1) PRIMARY KEY,
                title NVARCHAR(200) NOT NULL,
                description NVARCHAR(500) NOT NULL,
                tech_stack NVARCHAR(300) NOT NULL,
                url NVARCHAR(500) DEFAULT ''
              );

              IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'activities')
              CREATE TABLE activities (
                id INT IDENTITY(1,1) PRIMARY KEY,
                userId NVARCHAR(100) NOT NULL,
                type NVARCHAR(50) NOT NULL,
                description NVARCHAR(500) NOT NULL,
                metadata NVARCHAR(MAX) NULL,
                timestamp DATETIME2 DEFAULT GETUTCDATE()
              );

              IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'comments')
              CREATE TABLE comments (
                id INT IDENTITY(1,1) PRIMARY KEY,
                postId NVARCHAR(50) NOT NULL,
                author NVARCHAR(100) NOT NULL,
                content NVARCHAR(MAX) NOT NULL,
                timestamp DATETIME2 DEFAULT GETUTCDATE()
              );
              "

              echo "Seeding blog posts..."
              $SQLCMD -S "$SERVER" -d "$DB" -U "$USER" -P "$PASS" -Q "
              IF NOT EXISTS (SELECT 1 FROM posts WHERE slug = 'aks-networking')
              INSERT INTO posts (title, slug, content, category) VALUES
              ('Understanding AKS Networking', 'aks-networking', 'Azure CNI Overlay provides pod networking with a flat address space. Combined with Calico network policies, you get enterprise-grade network segmentation. This post covers hub-spoke topology, VNet peering, and how pods communicate across subnets.', 'Networking'),
              ('Workload Identity Deep Dive', 'workload-identity', 'Workload Identity eliminates the need for storing credentials. Using OIDC federation, your Kubernetes service accounts can authenticate directly to Azure services like SQL Database.', 'Security'),
              ('Cost Optimization on AKS', 'cost-optimization', 'Running AKS cost-effectively requires the right VM sizes, autoscaling configuration, and resource management. Learn about B-series VMs for dev/test, cluster autoscaler tuning, and Azure Cost Management.', 'Operations'),
              ('Private Endpoints for Data Services', 'private-endpoints', 'Private endpoints bring Azure PaaS services into your VNet. This post covers setting up private endpoints for Azure SQL with private DNS zones.', 'Networking'),
              ('Hub-Spoke Landing Zones with Terraform', 'landing-zones-terraform', 'Enterprise AKS deployments use landing zone patterns to separate concerns. This article explains how to structure Terraform modules for networking, security, identity, management, and data landing zones.', 'Infrastructure');
              "

              echo "Seeding exercises..."
              $SQLCMD -S "$SERVER" -d "$DB" -U "$USER" -P "$PASS" -Q "
              IF NOT EXISTS (SELECT 1 FROM exercises WHERE title = 'Deploy AKS Cluster')
              INSERT INTO exercises (title, description, difficulty) VALUES
              ('Deploy AKS Cluster', 'Create an AKS cluster with Azure CNI Overlay and Calico network policies using Terraform.', 'Beginner'),
              ('Configure Hub-Spoke Networking', 'Set up hub-spoke VNet topology with peering, NSGs, and route tables.', 'Intermediate'),
              ('Set Up Workload Identity', 'Configure OIDC issuer, managed identity, and federated credentials for passwordless Azure access.', 'Intermediate'),
              ('Deploy NGINX Ingress', 'Install NGINX ingress controller via Helm and expose a web application.', 'Beginner'),
              ('Configure Key Vault CSI', 'Deploy Secrets Store CSI Driver and mount Azure Key Vault secrets into pods.', 'Intermediate'),
              ('Implement Network Policies', 'Create Calico network policies for default-deny and selective allow rules.', 'Intermediate'),
              ('Set Up Monitoring Stack', 'Configure Container Insights, Prometheus scraping, and Grafana dashboards.', 'Advanced'),
              ('Add Private Endpoints', 'Create private endpoints for Azure SQL with DNS zone integration.', 'Advanced'),
              ('Configure HPA Autoscaling', 'Set up Horizontal Pod Autoscaler with CPU and custom metrics.', 'Intermediate'),
              ('Production Hardening', 'Apply pod security standards, resource quotas, limit ranges, and Azure Policy.', 'Advanced');
              "

              echo "Seeding projects..."
              $SQLCMD -S "$SERVER" -d "$DB" -U "$USER" -P "$PASS" -Q "
              IF NOT EXISTS (SELECT 1 FROM projects WHERE title = 'AKS Landing Zone Lab')
              INSERT INTO projects (title, description, tech_stack, url) VALUES
              ('AKS Landing Zone Lab', 'Enterprise AKS environment with hub-spoke networking, 6 landing zones, and 20+ Terraform modules.', 'Terraform, AKS, Azure CNI, Calico, Helm', 'https://github.com/Jamonygr/aks-landing-zone-lab'),
              ('Learning Hub Web App', 'Full-stack Next.js application running on AKS with Azure SQL backend.', 'Next.js, TypeScript, Azure SQL, Docker', ''),
              ('Monitoring and Observability', 'End-to-end observability with Container Insights, Prometheus, Grafana, and structured logging.', 'Prometheus, Grafana, Log Analytics, Container Insights', '');
              "

              echo "=== Seed complete ==="
          env:
            - name: SQL_SERVER_FQDN
              valueFrom:
                configMapKeyRef:
                  name: learning-hub-config
                  key: SQL_SERVER_FQDN
            - name: SQL_DATABASE_NAME
              valueFrom:
                configMapKeyRef:
                  name: learning-hub-config
                  key: SQL_DATABASE_NAME
            - name: SQL_ADMIN_USER
              value: "sqladmin"  # Matches the default in modules/sql-database
            - name: SQL_CONNECTION_STRING
              valueFrom:
                secretKeyRef:
                  name: learning-hub-db-secrets
                  key: sql-connection-string
                  optional: false
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 250m
              memory: 256Mi
