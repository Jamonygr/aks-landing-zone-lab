# secret-consumer.yaml
# Demonstrates Azure Key Vault integration via CSI Secrets Store Provider.
# SecretProviderClass maps Key Vault secrets, and a Pod mounts them as files.
---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-keyvault-secrets
  namespace: lab-apps
  labels:
    app: secret-consumer
    environment: lab
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: ""  # Replace with your managed identity client ID
    keyvaultName: ""            # Replace with your Key Vault name
    cloudName: "AzurePublicCloud"
    objects: |
      array:
        - |
          objectName: lab-secret-username
          objectType: secret
          objectVersion: ""
        - |
          objectName: lab-secret-password
          objectType: secret
          objectVersion: ""
        - |
          objectName: lab-connection-string
          objectType: secret
          objectVersion: ""
    tenantId: ""  # Replace with your Azure AD tenant ID
  # Optionally sync secrets to Kubernetes Secrets
  secretObjects:
    - secretName: keyvault-synced-secrets
      type: Opaque
      data:
        - objectName: lab-secret-username
          key: username
        - objectName: lab-secret-password
          key: password
        - objectName: lab-connection-string
          key: connection-string
---
apiVersion: v1
kind: Pod
metadata:
  name: secret-consumer
  namespace: lab-apps
  labels:
    app: secret-consumer
    environment: lab
  annotations:
    description: "Pod consuming secrets from Azure Key Vault via CSI driver"
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 65532
    runAsGroup: 65532
    fsGroup: 65532
    seccompProfile:
      type: RuntimeDefault
  containers:
    - name: secret-reader
      image: busybox:1.36
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "=== Secrets mounted from Azure Key Vault ===";
          echo "Secrets directory contents:";
          ls -la /mnt/secrets-store/;
          echo "";
          echo "--- Secret values (for testing only) ---";
          for f in /mnt/secrets-store/*; do
            echo "$(basename $f): $(cat $f)";
          done;
          echo "";
          echo "--- Synced Kubernetes Secret env vars ---";
          echo "USERNAME: $SECRET_USERNAME";
          echo "CONNECTION_STRING: $SECRET_CONNECTION_STRING";
          echo "=== Done ===";
          sleep 3600
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop: ["ALL"]
      env:
        - name: SECRET_USERNAME
          valueFrom:
            secretKeyRef:
              name: keyvault-synced-secrets
              key: username
        - name: SECRET_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keyvault-synced-secrets
              key: password
        - name: SECRET_CONNECTION_STRING
          valueFrom:
            secretKeyRef:
              name: keyvault-synced-secrets
              key: connection-string
      volumeMounts:
        - name: secrets-store
          mountPath: /mnt/secrets-store
          readOnly: true
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 128Mi
  volumes:
    - name: secrets-store
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: azure-keyvault-secrets
  restartPolicy: Never
